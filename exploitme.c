// -fno-stack-protector -no-pie -fomit-frame-pointer

#include <stdint.h>
#include <string.h>
#include <stdlib.h>
#include <stdio.h>
#include <ctype.h>

//__attribute__((no_sanitize("address")))
void hexdump64(uint64_t *data, size_t size) {
    char *cdata = (char *) data;
    for (size_t i = 0; i < size; i++) {
        printf("%02lu 0x%016lx ", i, data[i]);
        for (size_t j = 0; j < 8; j++)
            printf("%c", isprint(cdata[i * 8 + j]) ? cdata[i * 8 + j] : '.');
        puts("");
    }
    puts("");
}

void exploit(void) {
    asm(".rept 0x10000\nnop\n.endr");
    printf("exploit succeeded\r\n");
}

void copy(const char * user_input) {
    uint64_t x[1] = { 0xdeadbeefdeadbeef };

    hexdump64(x, 16);
    strcpy((char *) x, user_input);
    hexdump64(x, 16);
}

void
testfn0(void)
{
    uint64_t x[1] = { 0x3031323334353637 };

    printf("security training\n");

    hexdump64(x, 1);
}

void
testfn1(void)
{
    uint64_t x[1] = { 0xdeadbeefdeadbeef };

    printf("security training\n");

    hexdump64(x, 16);
}

int main(int argc, char* argv[]) {
    printf("exploit: %p\r\n", exploit);
    printf("main:    %p\r\n", main);
    switch(argc) {
        case 3:
            *(uint64_t *) (argv[1] + strlen(argv[1])) = strtol(argv[2], NULL, 0);
        case 2:
            copy(argv[1]);
            break;
        default:
            testfn0();
            testfn1();
    }
    puts("not crashed");
}
