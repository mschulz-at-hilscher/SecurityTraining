// Set Extra Compiler Flags to: -w

#include <stdio.h>
#include <string.h>

#include "hdr.h"

int verifyPassword(char *inputPassword) {
    if (strlen(inputPassword) <= PASSWORD_LENGTH && !memcmp(password, inputPassword, strlen(inputPassword)))
        return SUCCESS;
    else
        return ERROR_INVALID_PASSWORD;
}

int myHighlySecureDecrypt(char *plaintext, const char *ciphertext, size_t ciphertext_sz, const char *key) {
    for (unsigned int i = 0; i < ciphertext_sz; i++)
        plaintext[i] = ciphertext[i] ^ key[i % PASSWORD_LENGTH];
}

void printSecret(const char *user, const char *inputPassword) {
    char secret[] = "q/<'Wc7'\x02$'R";
    char usercpy[USER_LENGTH];

    myHighlySecureDecrypt(secret, secret, sizeof(secret) - 1, inputPassword);

    strncpy(usercpy, user, USER_LENGTH);

    if (((X usercpy) ^ (X password)) == (X secret))
        printf(secret);
    else
        printf("ERR: User '%s' not allowed to see secret.\n", usercpy);
}

int main(int argc, char* argv[]) {
    int ret = ERROR_INVALID_PASSWORD;
    if (argc == 1)
        printf("USAGE: getsecret USERNAME PASSWORD\n");
    if (argc >= 2)
        ret = verifyPassword(argv[2]);
    if (!ret && argc >= 3)
        printSecret(argv[1], argv[2]);

    return ret;
}
